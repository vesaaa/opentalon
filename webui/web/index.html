<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenTalon — 设备拓扑管理</title>
  <meta name="description" content="OpenTalon 开源跨平台设备管理与拓扑监控平台">

  <!-- AntV G6 拓扑图 -->
  <script src="https://unpkg.com/@antv/g6@4.8.24/dist/g6.min.js"></script>
  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Chart.js 仪表盘 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --accent: #58a6ff;
      --accent2: #3fb950;
      --warn: #e3b341;
      --danger: #f85149;
      --text: #e6edf3;
      --muted: #8b949e;
      --sidebar-w: 260px;
      --header-h: 52px;
    }

    body,
    #app {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ── */
    header {
      height: var(--header-h);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 14px;
      flex-shrink: 0;
    }

    .logo {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: .04em;
      color: var(--accent);
    }

    .logo span {
      color: var(--accent2);
    }

    .status-pill {
      margin-left: auto;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: .72rem;
      background: rgba(63, 185, 80, .12);
      color: var(--accent2);
      border: 1px solid var(--accent2);
    }

    /* ── Layout ── */
    .workspace {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* ── Sidebar ── */
    aside {
      width: var(--sidebar-w);
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }

    .sidebar-head {
      padding: 12px 14px;
      font-size: .7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    .device-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .group-label {
      padding: 6px 14px 4px;
      font-size: .68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
    }

    .device-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 14px;
      cursor: pointer;
      transition: background .15s;
    }

    .device-item:hover {
      background: rgba(88, 166, 255, .07);
    }

    .device-item.active {
      background: rgba(88, 166, 255, .14);
      border-left: 2px solid var(--accent);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .dot.online {
      background: var(--accent2);
      box-shadow: 0 0 6px var(--accent2);
    }

    .dot.offline {
      background: var(--muted);
    }

    .device-name {
      font-size: .82rem;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .device-ip {
      font-size: .7rem;
      color: var(--muted);
    }

    .child-item {
      padding-left: 30px;
    }

    /* ── Main Panel ── */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Topology canvas area */
    .topo-area {
      flex: 1;
      position: relative;
      background: var(--bg);
      background-image: radial-gradient(var(--border) 1px, transparent 0);
      background-size: 24px 24px;
    }

    #topo-canvas {
      width: 100%;
      height: 100%;
    }

    .topo-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--muted);
      font-size: .85rem;
      pointer-events: none;
      text-align: center;
    }

    /* ── Metrics Drawer ── */
    .drawer {
      width: 420px;
      height: 100%;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
      transform: translateX(100%);
      transition: transform .25s ease;
      position: absolute;
      right: 0;
      top: var(--header-h);
      bottom: 0;
      z-index: 10;
    }

    .drawer.open {
      transform: translateX(0);
    }

    .drawer-head {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .drawer-head h3 {
      flex: 1;
      font-size: .9rem;
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 1.1rem;
    }

    .close-btn:hover {
      color: var(--text);
    }

    .drawer-body {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Gauge */
    .gauge-row {
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }

    .gauge-card {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    }

    .gauge-label {
      font-size: .65rem;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .gauge-canvas {
      max-width: 100px;
      margin: 0 auto;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stat-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
    }

    .stat-label {
      font-size: .65rem;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
    }

    .stat-value.tcp {
      color: var(--accent);
    }

    .stat-value.udp {
      color: var(--warn);
    }

    .stat-value.rx {
      color: var(--accent2);
    }

    .stat-value.tx {
      color: var(--danger);
    }

    /* Device meta */
    .meta-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 9px;
      background: rgba(88, 166, 255, .1);
      border: 1px solid rgba(88, 166, 255, .25);
      border-radius: 20px;
      font-size: .7rem;
      color: var(--accent);
      margin: 2px;
    }

    /* Join bar */
    .join-bar {
      padding: 10px 14px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }

    .join-input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 7px 10px;
      color: var(--text);
      font-size: .8rem;
      outline: none;
    }

    .join-input:focus {
      border-color: var(--accent);
    }

    .join-btn {
      padding: 7px 14px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      font-size: .8rem;
      font-weight: 600;
      cursor: pointer;
    }

    .join-btn:hover {
      opacity: .85;
    }

    /* Login Overlay */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(13, 17, 23, 0.9);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .login-box {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 30px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .login-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      outline: none;
    }

    .login-input:focus {
      border-color: var(--accent);
    }

    .login-btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: var(--accent2);
      color: #000;
      font-weight: 600;
      cursor: pointer;
    }

    .login-btn:hover {
      opacity: 0.9;
    }

    ::-webkit-scrollbar {
      width: 5px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div id="app">
    <!-- ── Header ── -->
    <header>
      <div class="logo">Open<span>Talon</span></div>
      <span style="color:var(--muted);font-size:.8rem;">设备拓扑管理平台</span>
      <div class="status-pill">{{ onlineCount }} 台在线</div>
    </header>

    <div class="workspace" style="position:relative;">
      <!-- ── Sidebar ── -->
      <aside>
        <div class="sidebar-head">设备列表</div>
        <div class="device-list">
          <template v-for="group in groupedDevices" :key="group.name">
            <div class="group-label">{{ group.name || '默认分组' }}</div>
            <template v-for="dev in group.devices" :key="dev.id">
              <div class="device-item" :class="{active: selected?.id === dev.id}" @click="selectDevice(dev)">
                <div class="dot" :class="dev.is_online ? 'online':'offline'"></div>
                <div>
                  <div class="device-name">{{ dev.hostname }}</div>
                  <div class="device-ip">{{ dev.ip }}</div>
                </div>
              </div>
              <!-- Children (e.g. PVE VMs) -->
              <template v-if="dev.children?.length">
                <div v-for="child in dev.children" :key="child.id" class="device-item child-item"
                  :class="{active: selected?.id === child.id}" @click="selectDevice(child)">
                  <div class="dot" :class="child.is_online ? 'online':'offline'"></div>
                  <div>
                    <div class="device-name">↳ {{ child.hostname }}</div>
                    <div class="device-ip">{{ child.ip }}</div>
                  </div>
                </div>
              </template>
            </template>
          </template>
          <div v-if="!allDevices.length" style="padding:20px 14px;color:var(--muted);font-size:.8rem;">
            暂无设备。启动 Agent 后将自动显示。
          </div>
        </div>
        <!-- Join bar -->
        <div class="join-bar">
          <input class="join-input" id="join-addr" v-model="joinAddr" placeholder="设备 IP:端口" @keyup.enter="joinDevice">
          <button class="join-btn" @click="joinDevice">纳管</button>
        </div>
      </aside>

      <!-- ── Topology Canvas ── -->
      <main>
        <div class="topo-area">
          <div id="topo-canvas"></div>
          <div class="topo-hint" v-if="!allDevices.length && !showLogin">
            <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="9" />
              <path d="M12 8v4l3 3" />
            </svg>
            <p style="margin-top:10px">等待设备接入…</p>
            <p style="font-size:.72rem;margin-top:4px">运行 <code
                style="color:var(--accent)">opentalon agent --join &lt;server-ip&gt;</code></p>
          </div>
        </div>
      </main>

      <!-- ── Metrics Drawer ── -->
      <div class="drawer" :class="{open: drawerOpen}" id="metrics-drawer">
        <div class="drawer-head">
          <div class="dot" :class="selected?.is_online ? 'online':'offline'"></div>
          <h3>{{ selected?.hostname || '—' }}</h3>
          <button class="close-btn" id="close-drawer" @click="drawerOpen=false">✕</button>
        </div>
        <div class="drawer-body" v-if="selected">
          <!-- Meta chips -->
          <div>
            <span class="meta-chip">{{ selected.ip }}</span>
            <span class="meta-chip">{{ selected.os || 'Linux' }}</span>
            <span class="meta-chip">{{ selected.network_mode }}</span>
            <span class="meta-chip">{{ selected.group }}</span>
          </div>

          <!-- CPU / Mem gauges -->
          <div class="gauge-row">
            <div class="gauge-card">
              <div class="gauge-label">CPU</div>
              <div class="gauge-canvas"><canvas id="gauge-cpu"></canvas></div>
            </div>
            <div class="gauge-card">
              <div class="gauge-label">内存</div>
              <div class="gauge-canvas"><canvas id="gauge-mem"></canvas></div>
            </div>
            <div class="gauge-card">
              <div class="gauge-label">磁盘</div>
              <div class="gauge-canvas"><canvas id="gauge-disk"></canvas></div>
            </div>
          </div>

          <!-- Connections & Bandwidth -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">TCP 连接</div>
              <div class="stat-value tcp">{{ metrics?.tcp_connections ?? '—' }}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">UDP 连接</div>
              <div class="stat-value udp">{{ metrics?.udp_connections ?? '—' }}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">下行带宽</div>
              <div class="stat-value rx">{{ formatBytes(metrics?.rx_bytes) }}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">上行带宽</div>
              <div class="stat-value tx">{{ formatBytes(metrics?.tx_bytes) }}</div>
            </div>
          </div>

          <!-- Gateway -->
          <div class="stat-card">
            <div class="stat-label">默认网关</div>
            <div style="font-size:.85rem;margin-top:4px;">{{ selected.gateway_ip || metrics?.gateway_ip || '未知' }}</div>
          </div>
        </div>
      </div>
    </div><!-- .workspace -->

    <!-- ── Login Overlay ── -->
    <div class="login-overlay" v-if="showLogin">
      <div class="login-box">
        <div class="logo" style="justify-content:center; margin-bottom: 20px;">Open<span>Talon</span></div>
        <h3 style="text-align:center; margin-bottom:20px; font-weight:500;">Please Login</h3>
        <form @submit.prevent="doLogin">
          <input type="text" class="login-input" v-model="loginForm.username" placeholder="Username" required>
          <input type="password" class="login-input" v-model="loginForm.password" placeholder="Password" required>
          <button type="submit" class="login-btn">Login to Control Plane</button>
          <div v-if="loginForm.error"
            style="color:var(--danger); font-size:0.8rem; margin-top:10px; text-align:center;">
            {{ loginForm.error }}
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
      setup() {
        const tree = ref([]);
        const selected = ref(null);
        const metrics = ref(null);
        const drawerOpen = ref(false);
        const joinAddr = ref('');
        let g6Graph = null;
        let gaugeCharts = {};
        let pollTimer = null;

        // ── Flatten tree ──────────────────────────────────────────────────────────
        const allDevices = computed(() => flattenTree(tree.value));
        const onlineCount = computed(() => allDevices.value.filter(d => d.is_online).length);
        const groupedDevices = computed(() => {
          const map = {};
          tree.value.forEach(root => {
            const g = root.group || 'default';
            if (!map[g]) map[g] = { name: g, devices: [] };
            map[g].devices.push(root);
          });
          return Object.values(map);
        });

        const osIcons = {
          'windows': 'https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/windows11.svg',
          'linux': 'https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/linux.svg',
          'openwrt': 'https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/openwrt.svg',
          'merlin': 'https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/asus.svg',
          'fnos': 'https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/truenas.svg',
          'proxmox': 'https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/proxmox.svg',
          'mac': 'https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/apple.svg',
          'default': 'https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/serverless.svg'
        };

        function getOsIconUrl(osName) {
          if (!osName) return osIcons['default'];
          const lower = osName.toLowerCase();
          for (let key in osIcons) {
            if (lower.includes(key)) return osIcons[key];
          }
          return osIcons['default'];
        }

        function flattenTree(nodes, result = []) {
          nodes?.forEach(n => { result.push(n); flattenTree(n.children, result); });
          return result;
        }

        function buildG6Data(treeData, parentId = null, nodes = [], edges = []) {
          (treeData || []).forEach(dev => {
            nodes.push({
              id: String(dev.id),
              label: dev.hostname,
              img: getOsIconUrl(dev.os),
              style: {
                fill: dev.is_online ? '#3fb950' : '#8b949e', // Image tint/bg logic doesn't strictly apply, we rely on icon visually.
                stroke: dev.is_online ? '#3fb950' : '#30363d'
              },
              stateStyles: {
                selected: { stroke: '#58a6ff', lineWidth: 2, shadowColor: '#58a6ff', shadowBlur: 10 }
              }
            });
            if (parentId != null) {
              edges.push({ source: String(parentId), target: String(dev.id) });
            }
            if (dev.children?.length) buildG6Data(dev.children, dev.id, nodes, edges);
          });
          return { nodes, edges };
        }

        // ── Auth & API Wrapper ────────────────────────────────────────────────────
        const token = ref(localStorage.getItem('opentalon_jwt') || '');
        const showLogin = ref(!token.value);
        const loginForm = ref({ username: '', password: '', error: '' });

        async function apiFetch(url, options = {}) {
          if (!token.value) {
            showLogin.value = true;
            throw new Error("No token");
          }
          options.headers = {
            ...options.headers,
            'Authorization': `Bearer ${token.value}`
          };

          const res = await fetch(url, options);
          if (res.status === 401) {
            token.value = '';
            localStorage.removeItem('opentalon_jwt');
            showLogin.value = true;
            throw new Error("Unauthorized");
          }
          if (!res.ok) throw new Error(`API Error: ${res.status}`);
          return res;
        }

        async function doLogin() {
          try {
            loginForm.value.error = '';
            const res = await fetch('/api/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: loginForm.value.username, password: loginForm.value.password })
            });

            if (!res.ok) {
              const data = await res.json().catch(() => ({}));
              throw new Error(data.error || '登录失败');
            }

            const data = await res.json();
            token.value = data.token;
            localStorage.setItem('opentalon_jwt', token.value);
            showLogin.value = false;
            fetchTree(); // Try fetching again
          } catch (e) {
            loginForm.value.error = e.message;
          }
        }

        // ── Update Fetch Calls ────────────────────────────────────────────────────
        async function fetchTree() {
          if (!token.value) return; // Wait for login
          try {
            const res = await apiFetch('/api/devices/tree');
            const data = await res.json();
            tree.value = data.data || [];
            renderG6(tree.value);
          } catch (e) {
            if (e.message !== "No token" && e.message !== "Unauthorized") {
              // Server not running (dev mode) — use mock data if fetch completely fails
              tree.value = mockData();
              renderG6(tree.value);
            }
          }
        }

        async function fetchMetrics(deviceId) {
          if (!token.value) return;
          try {
            const res = await apiFetch(`/api/devices/${deviceId}/metrics`);
            const data = await res.json();
            metrics.value = data.data;
            updateGauges();
          } catch (e) {
            metrics.value = null;
          }
        }

        // ── Chart.js Gauges ───────────────────────────────────────────────────────
        function initGauges() {
          ['cpu', 'mem', 'disk'].forEach(k => {
            const el = document.getElementById(`gauge-${k}`);
            if (!el) return;
            if (gaugeCharts[k]) { gaugeCharts[k].destroy(); delete gaugeCharts[k]; }
            gaugeCharts[k] = new Chart(el, {
              type: 'doughnut',
              data: {
                datasets: [{
                  data: [0, 100],
                  backgroundColor: [gaugeColor(k), '#30363d'],
                  borderWidth: 0,
                  borderRadius: 4
                }]
              },
              options: {
                cutout: '72%', rotation: -90, circumference: 180,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                animation: { duration: 600 }
              }
            });
          });
        }

        function gaugeColor(k) {
          return { cpu: '#58a6ff', mem: '#3fb950', disk: '#e3b341' }[k];
        }

        function updateGauges() {
          if (!metrics.value) return;
          const vals = { cpu: metrics.value.cpu_usage, mem: metrics.value.mem_usage, disk: metrics.value.disk_usage };
          Object.entries(vals).forEach(([k, v]) => {
            const c = gaugeCharts[k];
            if (!c) return;
            const pct = Math.min(Math.max(v || 0, 0), 100);
            c.data.datasets[0].data = [pct, 100 - pct];
            c.update();
          });
        }

        // ── Utilities ─────────────────────────────────────────────────────────────
        function formatBytes(b) {
          if (b == null) return '—';
          if (b < 1024) return b + ' B/s';
          if (b < 1048576) return (b / 1024).toFixed(1) + ' KB/s';
          return (b / 1048576).toFixed(2) + ' MB/s';
        }

        function mockData() {
          return [
            {
              id: 1, hostname: 'Router-Main', ip: '192.168.1.1', os: 'OpenWrt', gateway_ip: '', group: '网络设备', network_mode: 'Bridged', is_online: true, children: [
                {
                  id: 3, hostname: 'PVE-Node1', ip: '192.168.1.10', os: 'Proxmox', gateway_ip: '192.168.1.1', group: '虚拟化', network_mode: 'Bridged', is_online: true, children: [
                    { id: 5, hostname: 'VM-fnos', ip: '192.168.1.20', os: 'FNOS', gateway_ip: '192.168.1.10', group: '虚拟化', network_mode: 'Bridged', is_online: false, children: [] },
                    { id: 6, hostname: 'VM-rocky', ip: '192.168.1.21', os: 'Rocky 9', gateway_ip: '192.168.1.10', group: '虚拟化', network_mode: 'NAT', is_online: true, children: [] }
                  ]
                },
                { id: 4, hostname: 'Win10-NUC', ip: '192.168.1.50', os: 'Windows', gateway_ip: '192.168.1.1', group: '工作站', network_mode: 'Bridged', is_online: true, children: [] }
              ]
            },
            { id: 2, hostname: 'Router-Side', ip: '192.168.1.2', os: 'Merlin', gateway_ip: '192.168.1.1', group: '网络设备', network_mode: 'Bridged', is_online: true, children: [] }
          ];
        }

        // ── Interaction ───────────────────────────────────────────────────────────
        function selectDevice(dev) {
          selected.value = dev;
          drawerOpen.value = true;
          metrics.value = null;
          fetchMetrics(dev.id);
          if (pollTimer) clearInterval(pollTimer);
          pollTimer = setInterval(() => fetchMetrics(dev.id), 5000);
          nextTick(initGauges);

          // Highlight in G6
          if (!g6Graph) return;
          g6Graph.getNodes().forEach(n => g6Graph.setItemState(n, 'selected', false));
          const node = g6Graph.findById(String(dev.id));
          if (node) g6Graph.setItemState(node, 'selected', true);
        }

        async function joinDevice() {
          if (!joinAddr.value.trim()) return;
          const host = joinAddr.value.trim();
          alert(`尝试用 SSH 纳管 ${host}... (此功能待后端实现)`);
          joinAddr.value = '';
        }

        // ── Render G6 Topology ────────────────────────────────────────────────────
        function renderG6(treeData) {
          if (!document.getElementById('topo-canvas') || treeData.length === 0) return;
          const { nodes, edges } = buildG6Data(treeData);

          if (!g6Graph) {
            const container = document.getElementById('topo-canvas');
            g6Graph = new G6.Graph({
              container,
              width: container.clientWidth,
              height: container.clientHeight,
              fitView: true,
              fitViewPadding: [40, 40, 40, 40],
              modes: {
                default: ['drag-canvas', 'zoom-canvas', 'drag-node', 'click-select']
              },
              layout: {
                type: 'dagre',
                rankdir: 'TB',
                nodesep: 50,
                ranksep: 70
              },
              defaultNode: {
                type: 'image',
                size: [48, 48],
                labelCfg: {
                  position: 'bottom',
                  offset: 8,
                  style: { fill: '#e6edf3', fontSize: 12, background: { fill: '#0d1117', padding: [2, 4], radius: 4 } }
                }
              },
              defaultEdge: {
                type: 'polyline',
                style: { radius: 10, stroke: '#58a6ff', lineWidth: 1.5, endArrow: true }
              },
              nodeStateStyles: {
                hover: { opacity: 0.8 },
                selected: { opacity: 1 }
              }
            });

            g6Graph.on('node:click', (e) => {
              const deviceId = parseInt(e.item.getModel().id, 10);
              const dev = allDevices.value.find(d => d.id === deviceId);
              if (dev) selectDevice(dev);
            });
            g6Graph.on('node:mouseenter', ({ item }) => g6Graph.setItemState(item, 'hover', true));
            g6Graph.on('node:mouseleave', ({ item }) => g6Graph.setItemState(item, 'hover', false));
          }

          g6Graph.data({ nodes, edges });
          g6Graph.render();

          // Sync selection
          if (selected.value) {
            const item = g6Graph.findById(String(selected.value.id));
            if (item) g6Graph.setItemState(item, 'selected', true);
          }
        }

        onMounted(() => {
          fetchTree();
          setInterval(fetchTree, 30000);
        });

        return {
          tree, allDevices, groupedDevices, onlineCount, selected, metrics,
          drawerOpen, joinAddr, selectDevice, joinDevice, formatBytes,
          token, showLogin, loginForm, doLogin
        };
      }
    }).mount('#app');
  </script>
</body>

</html>