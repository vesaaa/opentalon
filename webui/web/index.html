<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenTalon — 设备拓扑管理</title>
  <meta name="description" content="OpenTalon 开源跨平台设备管理与拓扑监控平台">

  <!-- AntV G6 拓扑图 -->
  <script src="https://unpkg.com/@antv/g6@4.8.24/dist/g6.min.js"></script>
  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Chart.js 仪表盘 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --accent: #58a6ff;
      --accent2: #3fb950;
      --warn: #e3b341;
      --danger: #f85149;
      --text: #e6edf3;
      --muted: #8b949e;
      --sidebar-w: 260px;
      --header-h: 52px;
    }

    body,
    #app {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ── */
    header {
      height: var(--header-h);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 14px;
      flex-shrink: 0;
    }

    .logo {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: .04em;
      color: var(--accent);
    }

    .logo span {
      color: var(--accent2);
    }

    .status-pill {
      margin-left: auto;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: .72rem;
      background: rgba(63, 185, 80, .12);
      color: var(--accent2);
      border: 1px solid var(--accent2);
    }

    /* ── Layout ── */
    .workspace {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* ── Sidebar ── */
    aside {
      width: var(--sidebar-w);
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }

    .sidebar-head {
      padding: 12px 14px;
      font-size: .7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    .device-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .group-label {
      padding: 6px 14px 4px;
      font-size: .68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
    }

    .device-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 14px;
      cursor: pointer;
      transition: background .15s;
    }

    .device-item:hover {
      background: rgba(88, 166, 255, .07);
    }

    .device-item.active {
      background: rgba(88, 166, 255, .14);
      border-left: 2px solid var(--accent);
    }

    .device-item.offline {
      opacity: 0.55;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .dot.online {
      background: var(--accent2);
      box-shadow: 0 0 6px var(--accent2);
    }

    .dot.offline {
      background: var(--muted);
    }

    .device-name {
      font-size: .82rem;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .device-ip {
      font-size: .7rem;
      color: var(--muted);
    }

    .child-item {
      padding-left: 30px;
    }

    /* ── Main Panel ── */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Topology canvas area */
    .topo-area {
      flex: 1;
      position: relative;
      background: var(--bg);
      background-image: radial-gradient(var(--border) 1px, transparent 0);
      background-size: 24px 24px;
    }

    #topo-canvas {
      width: 100%;
      height: 100%;
    }

    .topo-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--muted);
      font-size: .85rem;
      pointer-events: none;
      text-align: center;
    }

    /* ── Metrics Drawer ── */
    .drawer {
      width: 420px;
      height: 100%;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
      transform: translateX(100%);
      transition: transform .25s ease;
      position: absolute;
      right: 0;
      top: var(--header-h);
      bottom: 0;
      z-index: 10;
    }

    .drawer.open {
      transform: translateX(0);
    }

    .drawer-head {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .drawer-head h3 {
      flex: 1;
      font-size: .9rem;
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 1.1rem;
    }

    .close-btn:hover {
      color: var(--text);
    }

    .drawer-body {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .drawer-section-title {
      font-size: .75rem;
      font-weight: 600;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .drawer-form-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }
    .drawer-input {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 8px;
      color: var(--text);
      font-size: .8rem;
      outline: none;
    }
    .drawer-input:focus {
      border-color: var(--accent);
    }
    .drawer-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 8px;
    }
    .btn-primary {
      padding: 6px 12px;
      background: var(--accent2);
      color: #000;
      border-radius: 6px;
      border: none;
      font-size: .8rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .btn-danger {
      padding: 6px 10px;
      background: rgba(248, 81, 73, .15);
      color: var(--danger);
      border-radius: 6px;
      border: 1px solid rgba(248, 81, 73, .5);
      font-size: .75rem;
      cursor: pointer;
    }
    .btn-danger:hover {
      background: rgba(248, 81, 73, .25);
    }

    /* Gauge */
    .gauge-row {
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }

    .gauge-card {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    }

    .gauge-label {
      font-size: .65rem;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .gauge-canvas {
      max-width: 100px;
      margin: 0 auto;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stat-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
    }

    .stat-label {
      font-size: .65rem;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
    }

    .stat-value.tcp {
      color: var(--accent);
    }

    .stat-value.udp {
      color: var(--warn);
    }

    .stat-value.rx {
      color: var(--accent2);
    }

    .stat-value.tx {
      color: var(--danger);
    }

    /* Device meta */
    .meta-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 9px;
      background: rgba(88, 166, 255, .1);
      border: 1px solid rgba(88, 166, 255, .25);
      border-radius: 20px;
      font-size: .7rem;
      color: var(--accent);
      margin: 2px;
    }

    /* Join bar */
    .join-bar {
      padding: 10px 14px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }

    .join-input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 7px 10px;
      color: var(--text);
      font-size: .8rem;
      outline: none;
    }

    .join-input:focus {
      border-color: var(--accent);
    }

    .join-btn {
      padding: 7px 14px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      font-size: .8rem;
      font-weight: 600;
      cursor: pointer;
    }

    .join-btn:hover {
      opacity: .85;
    }

    /* Login Overlay */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(13, 17, 23, 0.9);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .login-box {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 30px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .login-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      outline: none;
    }

    .login-input:focus {
      border-color: var(--accent);
    }

    .login-btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: var(--accent2);
      color: #000;
      font-weight: 600;
      cursor: pointer;
    }

    .login-btn:hover {
      opacity: 0.9;
    }

    ::-webkit-scrollbar {
      width: 5px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div id="app">
    <!-- ── Header ── -->
    <header>
      <div class="logo">Open<span>Talon</span></div>
      <span style="color:var(--muted);font-size:.8rem;">设备拓扑管理平台</span>
      <div class="status-pill">{{ onlineCount }} 台在线</div>
    </header>

    <div class="workspace" style="position:relative;">
      <!-- ── Sidebar ── -->
      <aside>
        <div class="sidebar-head">设备列表</div>
        <div class="device-list">
          <template v-for="group in groupedDevices" :key="group.name">
            <div class="group-label">{{ group.name || '默认分组' }}</div>
            <template v-for="dev in group.devices" :key="dev.id">
              <div class="device-item"
                   :class="[{active: selected?.id === dev.id}, dev.is_online ? '' : 'offline']"
                   @click="selectDevice(dev)">
                <div class="dot" :class="dev.is_online ? 'online':'offline'"></div>
                <div>
                  <div class="device-name">{{ dev.remark || dev.hostname }}</div>
                  <div class="device-ip">{{ dev.ip }}</div>
                </div>
              </div>
              <!-- Children (e.g. PVE VMs) -->
              <template v-if="dev.children?.length">
                <div v-for="child in dev.children" :key="child.id"
                     class="device-item child-item"
                     :class="[{active: selected?.id === child.id}, child.is_online ? '' : 'offline']"
                     @click="selectDevice(child)">
                  <div class="dot" :class="child.is_online ? 'online':'offline'"></div>
                  <div>
                    <div class="device-name">↳ {{ child.remark || child.hostname }}</div>
                    <div class="device-ip">{{ child.ip }}</div>
                  </div>
                </div>
              </template>
            </template>
          </template>
          <div v-if="!allDevices.length" style="padding:20px 14px;color:var(--muted);font-size:.8rem;">
            暂无设备。启动 Agent 后将自动显示。
          </div>
        </div>
        <!-- Join bar -->
        <div class="join-bar">
          <input class="join-input" id="join-addr" v-model="joinAddr" placeholder="设备 IP:端口" @keyup.enter="joinDevice">
          <button class="join-btn" @click="joinDevice">纳管</button>
        </div>
      </aside>

      <!-- ── Topology Canvas ── -->
      <main>
        <div class="topo-area">
          <div style="position:absolute;top:10px;right:10px;z-index:5;display:flex;gap:6px;">
            <button class="btn-primary"
                    :style="{padding:'4px 10px',fontSize:'.72rem',background: viewMode==='network' ? 'var(--accent2)' : 'transparent', color: viewMode==='network' ? '#000' : 'var(--muted)', borderColor: 'var(--border)'}"
                    @click="viewMode='network'">
              网络拓扑
            </button>
            <button class="btn-primary"
                    :style="{padding:'4px 10px',fontSize:'.72rem',background: viewMode==='group' ? 'var(--accent2)' : 'transparent', color: viewMode==='group' ? '#000' : 'var(--muted)', borderColor: 'var(--border)'}"
                    @click="viewMode='group'">
              分组拓扑
            </button>
          </div>
          <div id="topo-canvas"></div>
          <div class="topo-hint" v-if="!allDevices.length && !showLogin">
            <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="9" />
              <path d="M12 8v4l3 3" />
            </svg>
            <p style="margin-top:10px">等待设备接入…</p>
            <p style="font-size:.72rem;margin-top:4px">运行 <code
                style="color:var(--accent)">opentalon agent --join &lt;server-ip&gt;</code></p>
          </div>
        </div>
      </main>

      <!-- ── Metrics Drawer ── -->
      <div class="drawer" :class="{open: drawerOpen}" id="metrics-drawer">
        <div class="drawer-head">
          <div class="dot" :class="selected?.is_online ? 'online':'offline'"></div>
          <h3>{{ selected ? (selected.remark || selected.hostname) : '—' }}</h3>
          <button class="close-btn" id="close-drawer" @click="drawerOpen=false">✕</button>
        </div>
        <div class="drawer-body" v-if="selected">
          <!-- Editable basics -->
          <div>
            <div class="drawer-section-title">设备信息</div>
            <div class="drawer-form-row">
              <label style="font-size:.75rem;color:var(--muted);">主机名（由 Agent 上报）</label>
              <div class="drawer-input" style="border-style:dashed;cursor:default;">
                {{ selected.hostname }}
              </div>
            </div>
            <div class="drawer-form-row">
              <label style="font-size:.75rem;color:var(--muted);">备注名称</label>
              <input class="drawer-input" v-model="editForm.remark" placeholder="用于界面展示的备注名称">
            </div>
            <div class="drawer-form-row">
              <label style="font-size:.75rem;color:var(--muted);">分组</label>
              <input class="drawer-input" v-model="editForm.group" placeholder="如：网络设备、虚拟化、工作站">
            </div>
            <div class="drawer-actions">
              <div>
                <button class="btn-primary" :disabled="saving" @click="saveDevice">保存</button>
              </div>
              <button class="btn-danger" @click="deleteDevice">删除设备</button>
            </div>
          </div>

          <!-- Meta chips -->
          <div>
            <span class="meta-chip">{{ selected.ip }}</span>
            <span class="meta-chip" :title="selected.os">{{ selected.os || 'Linux' }}</span>
            <span class="meta-chip">{{ selected.network_mode }}</span>
            <span class="meta-chip">{{ selected.group }}</span>
          </div>

          <!-- CPU / Mem gauges -->
          <div class="gauge-row">
            <div class="gauge-card">
              <div class="gauge-label">CPU</div>
              <div class="gauge-canvas"><canvas id="gauge-cpu"></canvas></div>
            </div>
            <div class="gauge-card">
              <div class="gauge-label">内存</div>
              <div class="gauge-canvas"><canvas id="gauge-mem"></canvas></div>
            </div>
            <div class="gauge-card">
              <div class="gauge-label">磁盘</div>
              <div class="gauge-canvas"><canvas id="gauge-disk"></canvas></div>
            </div>
          </div>

          <!-- Connections & Bandwidth -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">TCP 连接</div>
              <div class="stat-value tcp">{{ metrics?.tcp_connections ?? '—' }}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">UDP 连接</div>
              <div class="stat-value udp">{{ metrics?.udp_connections ?? '—' }}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">下行带宽</div>
              <div class="stat-value rx">{{ formatBytes(metrics?.rx_bytes) }}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">上行带宽</div>
              <div class="stat-value tx">{{ formatBytes(metrics?.tx_bytes) }}</div>
            </div>
          </div>

          <!-- Gateway -->
          <div class="stat-card">
            <div class="stat-label">默认网关</div>
            <div style="font-size:.85rem;margin-top:4px;">{{ selected.gateway_ip || metrics?.gateway_ip || '未知' }}</div>
          </div>
        </div>
      </div>
    </div><!-- .workspace -->

    <!-- ── Login Overlay ── -->
    <div class="login-overlay" v-if="showLogin">
      <div class="login-box">
        <div class="logo" style="justify-content:center; margin-bottom: 20px;">Open<span>Talon</span></div>
        <h3 style="text-align:center; margin-bottom:20px; font-weight:500;">Please Login</h3>
        <form @submit.prevent="doLogin">
          <input type="text" class="login-input" v-model="loginForm.username" placeholder="Username" required>
          <input type="password" class="login-input" v-model="loginForm.password" placeholder="Password" required>
          <button type="submit" class="login-btn">Login to Control Plane</button>
          <div v-if="loginForm.error"
            style="color:var(--danger); font-size:0.8rem; margin-top:10px; text-align:center;">
            {{ loginForm.error }}
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
      setup() {
        const tree = ref([]);
        const selected = ref(null);
        const metrics = ref(null);
        const drawerOpen = ref(false);
        const joinAddr = ref('');
        // Hostname is reported by agent and immutable from Web UI; only allow remark + group edits.
        const editForm = ref({ remark: '', group: '' });
        // topo view mode: 'network' | 'group'
        const viewMode = ref('network');
        const saving = ref(false);
        let g6Graph = null;
        let gaugeCharts = {};
        let pollTimer = null;

        // ── Flatten tree ──────────────────────────────────────────────────────────
        const allDevices = computed(() => flattenTree(tree.value));
        const onlineCount = computed(() => allDevices.value.filter(d => d.is_online).length);
        const groupedDevices = computed(() => {
          const map = {};
          tree.value.forEach(root => {
            const g = root.group || 'default';
            if (!map[g]) map[g] = { name: g, devices: [] };
            map[g].devices.push(root);
          });
          return Object.values(map);
        });

        // Tree used for G6 rendering under current view mode
        const displayTree = computed(() => {
          if (viewMode.value === 'group') {
            return buildGroupTree(tree.value);
          }
          return tree.value || [];
        });

        const SI = 'https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/';
        // 有序优先级规则列表：[关键字数组, icon文件名, 可选颜色（未用）]
        const osIconRules = [
          // Windows
          [['windows', 'win'], SI + 'windows11.svg'],
          // macOS
          [['macos', 'mac', 'darwin', 'osx'], SI + 'apple.svg'],
          // Android
          [['android'], SI + 'android.svg'],
          // Debian
          [['debian'], SI + 'debian.svg'],
          // Ubuntu
          [['ubuntu'], SI + 'ubuntu.svg'],
          // Rocky Linux
          [['rocky'], SI + 'rockylinux.svg'],
          // CentOS
          [['centos'], SI + 'centos.svg'],
          // Alpine
          [['alpine'], SI + 'alpinelinux.svg'],
          // Raspberry Pi / Raspbian
          [['raspberry', 'raspbian'], SI + 'raspberrypi.svg'],
          // Arch Linux
          [['arch'], SI + 'archlinux.svg'],
          // Fedora
          [['fedora'], SI + 'fedora.svg'],
          // openSUSE
          [['opensuse', 'suse'], SI + 'opensuse.svg'],
          // Proxmox / PVE
          [['proxmox', 'pve'], SI + 'proxmox.svg'],
          // OpenWrt
          [['openwrt'], SI + 'openwrt.svg'],
          // 梅林固件（华硕路由）
          [['merlin', 'asus'], SI + 'asus.svg'],
          // 飞牛 NAS / fnos
          [['fnos', '飞牛', 'truenas'], SI + 'truenas.svg'],
          // 群晖 Synology
          [['synology', 'dsm'], SI + 'synology.svg'],
          // UNRAID
          [['unraid'], SI + 'unraid.svg'],
          // FreeBSD
          [['freebsd', 'bsd'], SI + 'freebsd.svg'],
          // Linux 通用
          [['linux'], SI + 'linux.svg'],
          // 打印机
          [['print'], SI + 'adobeacrobatreader.svg'],
          // 路由器 / 交换机（通用网络）
          [['router', 'switch', '路由', '交换'], SI + 'cisco.svg'],
          // 摄像头 / IP Camera
          [['camera', 'cam', '摄像'], SI + 'opencv.svg'],
          // NAS 通用
          [['nas', 'storage'], SI + 'qnap.svg'],
          // 默认
          [['default'], SI + 'serverfault.svg']
        ];

        function getOsIconUrl(osName) {
          const lower = (osName || '').toLowerCase();
          for (const [keys, url] of osIconRules) {
            if (keys[0] === 'default') return url;
            if (keys.some(k => lower.includes(k))) return url;
          }
          return osIconRules[osIconRules.length - 1][1]; // default
        }

        // SVG 图标颜色缓存（white）
        const _iconCache = {};
        async function fetchColoredIcon(url, color = '#e6edf3') {
          const key = url + color;
          if (_iconCache[key]) return _iconCache[key];
          try {
            const res = await fetch(url);
            let svg = await res.text();
            // 给 SVG 加上 fill 颜色使其变为白色/浅色
            svg = svg.replace(/<svg /, `<svg fill="${color}" `);
            const dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
            _iconCache[key] = dataUrl;
            return dataUrl;
          } catch (e) {
            return url; // fallback
          }
        }



        function flattenTree(nodes, result = []) {
          nodes?.forEach(n => { result.push(n); flattenTree(n.children, result); });
          return result;
        }

        // Build a "group topology" tree: each group becomes a root node, children
        // are devices belonging to that group. Device-to-device parent links are
        // preserved under each group root to roughly mirror the network topology.
        function buildGroupTree(originalTree) {
          const flat = flattenTree(originalTree || []);
          const byGroup = {};
          flat.forEach(dev => {
            const g = dev.group || 'default';
            if (!byGroup[g]) byGroup[g] = [];
            byGroup[g].push(dev);
          });
          const roots = [];
          Object.entries(byGroup).forEach(([groupName, devices]) => {
            roots.push({
              id: `group:${groupName}`,
              hostname: groupName || '默认分组',
              remark: '',
              ip: '',
              os: 'Group',
              gateway_ip: '',
              network_mode: 'Group',
              group: groupName,
              is_online: true,
              children: devices
            });
          });
          return roots;
        }

        function buildG6Data(treeData, parentId = null, nodes = [], edges = []) {
          (treeData || []).forEach(dev => {
            const bgColor = dev.is_online ? '#1a4d2e' : '#21262d';
            const strokeColor = dev.is_online ? '#3fb950' : '#444c56';
            const iconUrl = getOsIconUrl(dev.os);
            nodes.push({
              id: String(dev.id),
              label: dev.hostname,
              type: 'ot-device-node',
              iconUrl,
              os: dev.os,
              isOnline: dev.is_online,
              style: { fill: bgColor, stroke: strokeColor, lineWidth: 2 },
              stateStyles: {
                selected: { fill: bgColor, stroke: '#58a6ff', lineWidth: 2.5, shadowColor: '#58a6ff', shadowBlur: 12 },
                hover: { fill: bgColor, stroke: strokeColor, opacity: 0.85 }
              }
            });
            if (parentId != null) {
              edges.push({ source: String(parentId), target: String(dev.id) });
            }
            if (dev.children?.length) buildG6Data(dev.children, dev.id, nodes, edges);
          });
          return { nodes, edges };
        }

        // 注册自定义节点：圆形背景 + 中央白色 SVG 图标
        function registerOtNode() {
          if (G6.Global.customNodes && G6.Global.customNodes['ot-device-node']) return;
          G6.registerNode('ot-device-node', {
            draw(cfg, group) {
              const size = 40;
              const r = size / 2;
              const fill = (cfg.style && cfg.style.fill) || '#1a4d2e';
              const stroke = (cfg.style && cfg.style.stroke) || '#3fb950';
              const shape = group.addShape('circle', {
                attrs: { x: 0, y: 0, r, fill, stroke, lineWidth: 2 },
                name: 'node-circle',
                draggable: true
              });
              // 图标 image，先用占位，后面用 fetchColoredIcon 更新
              const iconSize = 22;
              const img = group.addShape('image', {
                attrs: {
                  x: -iconSize / 2, y: -iconSize / 2,
                  width: iconSize, height: iconSize,
                  img: cfg.iconUrl || ''
                },
                name: 'node-icon',
                draggable: true
              });
              // 异步替换为白色图标
              if (cfg.iconUrl) {
                fetchColoredIcon(cfg.iconUrl, '#e6edf3').then(dataUrl => {
                  try { img.attr('img', dataUrl); } catch (e) { }
                });
              }
              // 标签（手动绘制在圆圈下方，避免 G6 默认标签被圆圈遮挡）
              group.addShape('text', {
                attrs: {
                  text: cfg.label || '',
                  x: 0, y: r + 14,
                  textAlign: 'center',
                  textBaseline: 'middle',
                  fill: '#e6edf3',
                  fontSize: 11,
                  fontFamily: 'Inter, system-ui, sans-serif'
                },
                name: 'node-label',
                draggable: true
              });
              return shape;
            },
            setState(name, value, item) {
              const group = item.getContainer();
              const circle = group.find(el => el.get('name') === 'node-circle');
              if (!circle) return;
              const model = item.getModel();
              const baseFill = (model.style && model.style.fill) || '#1a4d2e';
              const baseStroke = (model.style && model.style.stroke) || '#3fb950';
              if (name === 'selected') {
                circle.attr('stroke', value ? '#58a6ff' : baseStroke);
                circle.attr('lineWidth', value ? 2.5 : 2);
                circle.attr('shadowColor', value ? '#58a6ff' : 'transparent');
                circle.attr('shadowBlur', value ? 12 : 0);
              }
              if (name === 'hover') {
                circle.attr('opacity', value ? 0.8 : 1);
              }
            },
            getAnchorPoints() {
              return [[0.5, 0], [0.5, 1], [0, 0.5], [1, 0.5]];
            },
            update: undefined
          }, 'single-node');
        }

        // ── Auth & API Wrapper ────────────────────────────────────────────────────
        const token = ref(localStorage.getItem('opentalon_jwt') || '');
        const showLogin = ref(!token.value);
        const loginForm = ref({ username: '', password: '', error: '' });

        async function apiFetch(url, options = {}) {
          if (!token.value) {
            showLogin.value = true;
            throw new Error("No token");
          }
          options.headers = {
            ...options.headers,
            'Authorization': `Bearer ${token.value}`
          };

          const res = await fetch(url, options);
          if (res.status === 401) {
            token.value = '';
            localStorage.removeItem('opentalon_jwt');
            showLogin.value = true;
            throw new Error("Unauthorized");
          }
          if (!res.ok) throw new Error(`API Error: ${res.status}`);
          return res;
        }

        async function doLogin() {
          try {
            loginForm.value.error = '';
            const res = await fetch('/api/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: loginForm.value.username, password: loginForm.value.password })
            });

            if (!res.ok) {
              const data = await res.json().catch(() => ({}));
              throw new Error(data.error || '登录失败');
            }

            const data = await res.json();
            token.value = data.token;
            localStorage.setItem('opentalon_jwt', token.value);
            showLogin.value = false;
            fetchTree(); // Try fetching again
          } catch (e) {
            loginForm.value.error = e.message;
          }
        }

        // ── Update Fetch Calls ────────────────────────────────────────────────────
        async function fetchTree() {
          if (!token.value) return; // Wait for login
          try {
            const res = await apiFetch('/api/devices/tree');
            const data = await res.json();
            tree.value = data.data || [];
            renderG6(displayTree.value);
            // Refresh selected reference from latest tree so edits reflect
            if (selected.value) {
              const flat = flattenTree(tree.value);
              const cur = flat.find(d => d.id === selected.value.id);
              if (cur) {
                selected.value = cur;
                editForm.value.remark = cur.remark || '';
                editForm.value.group = cur.group || '';
              }
            }
          } catch (e) {
            // 在生产环境下不再注入 mock 数据，保持当前拓扑不变，避免出现不存在的示例设备
            console.error('fetchTree error', e);
          }
        }

        async function fetchMetrics(deviceId) {
          if (!token.value) return;
          try {
            const res = await apiFetch(`/api/devices/${deviceId}/metrics`);
            const data = await res.json();
            metrics.value = data.data;
            updateGauges();
          } catch (e) {
            metrics.value = null;
          }
        }

        // ── Chart.js Gauges ───────────────────────────────────────────────────────
        function initGauges() {
          ['cpu', 'mem', 'disk'].forEach(k => {
            const el = document.getElementById(`gauge-${k}`);
            if (!el) return;
            if (gaugeCharts[k]) { gaugeCharts[k].destroy(); delete gaugeCharts[k]; }
            gaugeCharts[k] = new Chart(el, {
              type: 'doughnut',
              data: {
                datasets: [{
                  data: [0, 100],
                  backgroundColor: [gaugeColor(k), '#30363d'],
                  borderWidth: 0,
                  borderRadius: 4
                }]
              },
              options: {
                cutout: '72%', rotation: -90, circumference: 180,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                animation: { duration: 600 }
              }
            });
          });
        }

        function gaugeColor(k) {
          return { cpu: '#58a6ff', mem: '#3fb950', disk: '#e3b341' }[k];
        }

        function updateGauges() {
          if (!metrics.value) return;
          const vals = { cpu: metrics.value.cpu_usage, mem: metrics.value.mem_usage, disk: metrics.value.disk_usage };
          Object.entries(vals).forEach(([k, v]) => {
            const c = gaugeCharts[k];
            if (!c) return;
            const pct = Math.min(Math.max(v || 0, 0), 100);
            c.data.datasets[0].data = [pct, 100 - pct];
            c.update();
          });
        }

        // ── Utilities ─────────────────────────────────────────────────────────────
        function formatBytes(b) {
          if (b == null) return '—';
          if (b < 1024) return b + ' B/s';
          if (b < 1048576) return (b / 1024).toFixed(1) + ' KB/s';
          return (b / 1048576).toFixed(2) + ' MB/s';
        }

        function mockData() {
          return [
            {
              id: 1, hostname: 'Router-Main', ip: '192.168.1.1', os: 'OpenWrt', gateway_ip: '', group: '网络设备', network_mode: 'Bridged', is_online: true, children: [
                {
                  id: 3, hostname: 'PVE-Node1', ip: '192.168.1.10', os: 'Proxmox', gateway_ip: '192.168.1.1', group: '虚拟化', network_mode: 'Bridged', is_online: true, children: [
                    { id: 5, hostname: 'VM-fnos', ip: '192.168.1.20', os: 'FNOS', gateway_ip: '192.168.1.10', group: '虚拟化', network_mode: 'Bridged', is_online: false, children: [] },
                    { id: 6, hostname: 'VM-rocky', ip: '192.168.1.21', os: 'Rocky 9', gateway_ip: '192.168.1.10', group: '虚拟化', network_mode: 'NAT', is_online: true, children: [] }
                  ]
                },
                { id: 4, hostname: 'Win10-NUC', ip: '192.168.1.50', os: 'Windows', gateway_ip: '192.168.1.1', group: '工作站', network_mode: 'Bridged', is_online: true, children: [] }
              ]
            },
            { id: 2, hostname: 'Router-Side', ip: '192.168.1.2', os: 'Merlin', gateway_ip: '192.168.1.1', group: '网络设备', network_mode: 'Bridged', is_online: true, children: [] }
          ];
        }

        // ── Interaction ───────────────────────────────────────────────────────────
        function selectDevice(dev) {
          selected.value = dev;
          drawerOpen.value = true;
          metrics.value = null;
          editForm.value.remark = dev.remark || '';
          editForm.value.group = dev.group || '';
          fetchMetrics(dev.id);
          if (pollTimer) clearInterval(pollTimer);
          pollTimer = setInterval(() => fetchMetrics(dev.id), 5000);
          nextTick(initGauges);

          // Highlight in G6
          if (!g6Graph) return;
          g6Graph.getNodes().forEach(n => g6Graph.setItemState(n, 'selected', false));
          const node = g6Graph.findById(String(dev.id));
          if (node) g6Graph.setItemState(node, 'selected', true);
        }

        async function joinDevice() {
          if (!joinAddr.value.trim()) return;
          const host = joinAddr.value.trim();
          alert(`尝试用 SSH 纳管 ${host}... (此功能待后端实现)`);
          joinAddr.value = '';
        }

        // ── Render G6 Topology ────────────────────────────────────────────────────
        function renderG6(treeData) {
          if (!document.getElementById('topo-canvas') || treeData.length === 0) return;
          const { nodes, edges } = buildG6Data(treeData);

          if (!g6Graph) {
            registerOtNode();

            const tooltip = new G6.Tooltip({
              offsetX: 10,
              offsetY: 10,
              itemTypes: ['node'],
              getContent(e) {
                const outDiv = document.createElement('div');
                outDiv.style.width = 'fit-content';
                const model = e.item.getModel();
                outDiv.innerHTML = `
                  <div style="padding: 6px 10px; font-size: 11px; color: #e6edf3; background: #161b22; border: 1px solid #30363d; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                    ${model.os || '未知系统'}
                  </div>`;
                return outDiv;
              }
            });

            const container = document.getElementById('topo-canvas');
            g6Graph = new G6.Graph({
              container,
              width: container.clientWidth,
              height: container.clientHeight,
              fitView: true,
              fitViewPadding: [50, 50, 50, 50],
              minZoom: 0.5,
              maxZoom: 2,
              modes: {
                default: ['drag-canvas', 'zoom-canvas', 'drag-node', 'brush-select']
              },
              plugins: [tooltip],
              layout: {
                type: 'dagre',
                rankdir: 'TB',
                nodesep: 40,
                ranksep: 60
              },
              defaultNode: {
                type: 'ot-device-node',
                size: 40
              },
              defaultEdge: {
                type: 'polyline',
                style: { radius: 10, stroke: '#30363d', lineWidth: 1.5, endArrow: { path: G6.Arrow.triangle(6, 8, 5), fill: '#30363d' } }
              },
              nodeStateStyles: {}
            });

            // 点击单个节点选中 + 同步到右侧抽屉
            g6Graph.on('node:click', (e) => {
              const deviceId = parseInt(e.item.getModel().id, 10);
              const dev = allDevices.value.find(d => d.id === deviceId);
              if (dev) selectDevice(dev);
            });
            g6Graph.on('node:mouseenter', ({ item }) => g6Graph.setItemState(item, 'hover', true));
            g6Graph.on('node:mouseleave', ({ item }) => g6Graph.setItemState(item, 'hover', false));

            // 框选多节点
            let brushSelectedIds = new Set();
            let dragContext = null;

            g6Graph.on('brushselectend', (e) => {
              brushSelectedIds = new Set();
              g6Graph.getNodes().forEach(n => g6Graph.setItemState(n, 'selected', false));
              (e.selectedItems?.nodes || []).forEach(node => {
                const id = node.getID();
                brushSelectedIds.add(id);
                g6Graph.setItemState(node, 'selected', true);
              });
            });

            // 拖拽时如果节点在当前框选集合中，则整体一起移动
            g6Graph.on('node:dragstart', (e) => {
              const node = e.item;
              const id = node.getID();
              const ids = (brushSelectedIds.size > 0 && brushSelectedIds.has(id))
                ? Array.from(brushSelectedIds)
                : [id];
              const originPositions = new Map();
              ids.forEach(nid => {
                const item = g6Graph.findById(nid);
                if (item) {
                  const m = item.getModel();
                  originPositions.set(nid, { x: m.x, y: m.y });
                }
              });
              dragContext = {
                ids,
                originPositions,
                startX: e.x,
                startY: e.y
              };
            });

            g6Graph.on('node:drag', (e) => {
              if (!dragContext) return;
              const dx = e.x - dragContext.startX;
              const dy = e.y - dragContext.startY;
              dragContext.ids.forEach(nid => {
                const item = g6Graph.findById(nid);
                const origin = dragContext.originPositions.get(nid);
                if (item && origin) {
                  g6Graph.updateItem(item, { x: origin.x + dx, y: origin.y + dy });
                }
              });
            });

            g6Graph.on('node:dragend', () => {
              dragContext = null;
            });
          }

          // 首次渲染用 data+render；后续更新用 changeData（支持动态增删节点）
          const isFirstRender = !g6Graph._hasRendered;
          if (isFirstRender) {
            g6Graph.data({ nodes, edges });
            g6Graph.render();
            g6Graph._hasRendered = true;
            g6Graph.fitView();
          } else {
            const zoom = g6Graph.getZoom();
            const center = g6Graph.getPointByCanvas(g6Graph.getWidth() / 2, g6Graph.getHeight() / 2);
            g6Graph.changeData({ nodes, edges });
            // 尽量保持用户当前缩放和视角不变，避免更新数据后图标突然变大或变小
            g6Graph.zoomTo(zoom, { x: g6Graph.getWidth() / 2, y: g6Graph.getHeight() / 2 });
            if (center) {
              g6Graph.focusPoint(center.x, center.y);
            }
          }

          // Sync selection
          if (selected.value) {
            const item = g6Graph.findById(String(selected.value.id));
            if (item) g6Graph.setItemState(item, 'selected', true);
          }
        }

        onMounted(() => {
          fetchTree();
          // 拓扑和基础信息刷新频率：8 秒一轮，兼顾 200 台设备下的压力与实时性
          setInterval(fetchTree, 8000);
        });

        async function saveDevice() {
          if (!selected.value) return;
          if (!token.value) {
            showLogin.value = true;
            return;
          }
          try {
            saving.value = true;
            await apiFetch(`/api/devices/${selected.value.id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                remark: editForm.value.remark || '',
                group: editForm.value.group || undefined
              })
            });
            await fetchTree();
          } catch (e) {
            console.error(e);
          } finally {
            saving.value = false;
          }
        }

        async function deleteDevice() {
          if (!selected.value) return;
          if (!token.value) {
            showLogin.value = true;
            return;
          }
          if (!confirm(`确定删除设备 ${selected.value.hostname || selected.value.ip} 吗？`)) {
            return;
          }
          try {
            await apiFetch(`/api/devices/${selected.value.id}`, {
              method: 'DELETE'
            });
            drawerOpen.value = false;
            selected.value = null;
            metrics.value = null;
            await fetchTree();
          } catch (e) {
            console.error(e);
          }
        }

        return {
          tree, allDevices, groupedDevices, onlineCount, selected, metrics,
          drawerOpen, joinAddr, selectDevice, joinDevice, formatBytes,
          token, showLogin, loginForm, doLogin,
          editForm, saving, saveDevice, deleteDevice,
          viewMode, displayTree
        };
      }
    }).mount('#app');
  </script>
</body>

</html>